image: docker:20.10.3

variables:
  DOCKER_HOST: tcp://docker:2375
  DOCKER_TLS_CERTDIR: ''
  DOCKER_DRIVER: overlay2
  GIT_SUBMODULE_STRATEGY: recursive

services:
  - name: docker:20.10.3-dind

.k8sdeployuat:
  # only:
  #   - develop
  image:
    name: ${K8S_DEPLOY_IMAGE}
    entrypoint: [""]
  stage: deploy
  dependencies:
    - apiVersion
  tags:
    - testuat
  before_script:
    - echo "$K8SCONF" > k8sconfig
    - export KUBECONFIG="$CI_PROJECT_DIR/k8sconfig"
    - export CI_IMAGE_TAG=$(cat version/current.ver)
  script:
    - sed -ie "s/from_ci_NS/$NAMESPACE/g" $CI_PROJECT_DIR/.gitlab/ci/manifests/deploymentsuat.yml
    - sed -ie "s/from_ci_APPDOMAIN/$APPDOMAIN/g" $CI_PROJECT_DIR/.gitlab/ci/manifests/deploymentsuat.yml
    - sed -ie "s/from_ci_TAG/$CI_COMMIT_SHORT_SHA/g" $CI_PROJECT_DIR/.gitlab/ci/manifests/deploymentsuat.yml
    - sed -ie "s/domain_CI/$DOMAIN_CI/g" $CI_PROJECT_DIR/.gitlab/ci/manifests/deploymentsuat.yml
    - sed -ie "s/from_ci_IPS1/$IPS1/g" $CI_PROJECT_DIR/.gitlab/ci/manifests/deploymentsuat.yml
    - sed -ie "s/from_ci_IPS2/$IPS2/g" $CI_PROJECT_DIR/.gitlab/ci/manifests/deploymentsuat.yml
    - sed -ie "s/from_ci_IPS3/$IPS3/g" $CI_PROJECT_DIR/.gitlab/ci/manifests/deploymentsuat.yml
    - sed -ie "s/from_ci_KAFKA2/$KAFKA2/g" $CI_PROJECT_DIR/.gitlab/ci/manifests/deploymentsuat.yml
    - sed -ie "s/from_ci_KAFKA1/$KAFKA1/g" $CI_PROJECT_DIR/.gitlab/ci/manifests/deploymentsuat.yml
    - sed -ie "s/from_ci_KAFKA3/$KAFKA3/g" $CI_PROJECT_DIR/.gitlab/ci/manifests/deploymentsuat.yml
    - sed -ie "s/from_ci_TLS/$TLS/g" $CI_PROJECT_DIR/.gitlab/ci/manifests/deploymentsuat.yml
    - kubectl -n $NAMESPACE apply -f $CI_PROJECT_DIR/.gitlab/ci/manifests/deploymentsuat.yml
    - >
      if ! kubectl -n $NAMESPACE rollout status deployment audit-service-api; then
        kubectl -n $NAMESPACE rollout undo deployment audit-service-api
        kubectl -n $NAMESPACE rollout status deployment audit-service-api
        exit 1
      fi
    - notify deploy --env ${K8S_ENV} --service-name ${CI_PROJECT_NAME} --version ${CI_IMAGE_TAG} --commit ${CI_COMMIT_SHA}

.k8sdeploy:
  # only:
  #   - develop
  image:
    name: ${K8S_DEPLOY_IMAGE}
    entrypoint: [""]
  stage: deploy
  dependencies:
    - apiVersion
    - sonar
  tags:
    - demo
    - lt
    - prod
  before_script:
    - echo "$K8SCONF" > k8sconfig
    - export KUBECONFIG="$CI_PROJECT_DIR/k8sconfig"
    - export CI_IMAGE_TAG=$(cat version/current.ver)
  script:
    - sed -ie "s/from_ci_NS/$NAMESPACE/g" $CI_PROJECT_DIR/.gitlab/ci/manifests/deployments.yml
    - sed -ie "s/from_ci_APPDOMAIN/$APPDOMAIN/g" $CI_PROJECT_DIR/.gitlab/ci/manifests/deployments.yml
    - sed -ie "s/from_ci_TAG/$CI_COMMIT_SHORT_SHA/g" $CI_PROJECT_DIR/.gitlab/ci/manifests/deployments.yml
    - sed -ie "s/domain_CI/$DOMAIN_CI/g" $CI_PROJECT_DIR/.gitlab/ci/manifests/deployments.yml
    - sed -ie "s/from_ci_IPS1/$IPS1/g" $CI_PROJECT_DIR/.gitlab/ci/manifests/deployments.yml
    - sed -ie "s/from_ci_IPS2/$IPS2/g" $CI_PROJECT_DIR/.gitlab/ci/manifests/deployments.yml
    - sed -ie "s/from_ci_IPS3/$IPS3/g" $CI_PROJECT_DIR/.gitlab/ci/manifests/deployments.yml
    - sed -ie "s/from_ci_KAFKA2/$KAFKA2/g" $CI_PROJECT_DIR/.gitlab/ci/manifests/deployments.yml
    - sed -ie "s/from_ci_KAFKA1/$KAFKA1/g" $CI_PROJECT_DIR/.gitlab/ci/manifests/deployments.yml
    - sed -ie "s/from_ci_KAFKA3/$KAFKA3/g" $CI_PROJECT_DIR/.gitlab/ci/manifests/deployments.yml
    - sed -ie "s/from_ci_TLS/$TLS/g" $CI_PROJECT_DIR/.gitlab/ci/manifests/deployments.yml
    - kubectl -n $NAMESPACE apply -f $CI_PROJECT_DIR/.gitlab/ci/manifests/deployments.yml
    - >
      if ! kubectl -n $NAMESPACE rollout status deployment audit-service-api; then
        kubectl -n $NAMESPACE rollout undo deployment audit-service-api
        kubectl -n $NAMESPACE rollout status deployment audit-service-api
        exit 1
      fi
    - notify deploy --env ${K8S_ENV} --service-name ${CI_PROJECT_NAME} --version ${CI_IMAGE_TAG} --commit ${CI_COMMIT_SHA}

test deploy:
  extends: .k8sdeployuat
  when: manual
  environment:
    name: test
  variables:
    K8S_ENV: test
    NAMESPACE: "test-tolar-audit-service"
    K8SCONF: "$KUBECFG"
    DOMAIN_CI: "netreportservice.xyz"
    APPDOMAIN: "test-audit-p2"
    KAFKA1: kafka-b1.netreportservice.xyz
    KAFKA2: kafka-b2.netreportservice.xyz
    KAFKA3: kafka-b3.netreportservice.xyz
    IPS1: 10.0.0.35
    IPS2: 10.0.0.30
    IPS3: 10.0.0.25
    TLS: wildcard-tls
  tags:
    - testuat

test2 deploy:
  extends: .k8sdeployuat
  when: manual
  environment:
    name: test2
  variables:
    K8S_ENV: test2
    NAMESPACE: "test2"
    K8SCONF: "$KUBECFG"
    DOMAIN_CI: "netreportservice.xyz"
    APPDOMAIN: "test2-audit-p2"
    KAFKA1: kafka-b1.netreportservice.xyz
    KAFKA2: kafka-b2.netreportservice.xyz
    KAFKA3: kafka-b3.netreportservice.xyz
    IPS1: 10.0.0.35
    IPS2: 10.0.0.30
    IPS3: 10.0.0.25
    TLS: wildcard-tls
  tags:
    - testuat

test3 deploy:
  extends: .k8sdeployuat
  when: manual
  environment:
    name: test3
  variables:
    K8S_ENV: test3
    NAMESPACE: "test3"
    K8SCONF: "$KUBECFG"
    DOMAIN_CI: "netreportservice.xyz"
    APPDOMAIN: "test3-audit-p2"
    KAFKA1: kafka-b1.netreportservice.xyz
    KAFKA2: kafka-b2.netreportservice.xyz
    KAFKA3: kafka-b3.netreportservice.xyz
    IPS1: 10.0.0.35
    IPS2: 10.0.0.30
    IPS3: 10.0.0.25
    TLS: wildcard-tls
  tags:
    - testuat

uat deploy:
  extends: .k8sdeployuat
  when: manual
  environment:
    name: uat
  variables:
    K8S_ENV: uat
    NAMESPACE: "tolar-audit-service"
    K8SCONF: "$KUBECFG"
    DOMAIN_CI: "netreportservice.xyz"
    APPDOMAIN: "audit-p2"
    KAFKA1: kafka-b1.netreportservice.xyz
    KAFKA2: kafka-b2.netreportservice.xyz
    KAFKA3: kafka-b3.netreportservice.xyz
    IPS1: 10.0.0.35
    IPS2: 10.0.0.30
    IPS3: 10.0.0.25
    TLS: wildcard-tls
  tags:
    - testuat

t9 deploy:
  extends: .k8sdeployuat
  when: manual
  environment:
    name: t9
  variables:
    K8S_ENV: test-t9
    NAMESPACE: "t9"
    K8SCONF: "$KUBECFG"
    DOMAIN_CI: "netreportservice.xyz"
    APPDOMAIN: "t9-audit-p2"
    KAFKA1: kafka-b1.netreportservice.xyz
    KAFKA2: kafka-b2.netreportservice.xyz
    KAFKA3: kafka-b3.netreportservice.xyz
    IPS1: 10.0.0.35
    IPS2: 10.0.0.30
    IPS3: 10.0.0.25
    TLS: wildcard-tls
  tags:
    - testuat

demo deploy:
  extends: .k8sdeploy
  when: manual
  environment:
    name: demo
  only:
    # - develop
    - web
  variables:
    K8S_ENV: demo
    NAMESPACE: "core2"
    K8SCONF: "$DEMOKUBECFG"
    DOMAIN_CI: "k8demo.cyou"
    APPDOMAIN: "audit-p2"
    KAFKA1: demo-kafka-b1.ganet.pw
    KAFKA2: demo-kafka-b2.ganet.pw
    KAFKA3: demo-kafka-b3.ganet.pw
    IPS1: 212.8.243.106
    IPS2: 212.8.243.109
    IPS3: 212.8.243.107
    TLS: cloudflare-tls
  tags:
    - demo

lt deploy:
  extends: .k8sdeploy
  when: manual
  environment:
    name: lt
  only:
    - master
    - web
  variables:
    K8S_ENV: lt
    NAMESPACE: "audit"
    K8SCONF: "$LTKUBECFG"
    DOMAIN_CI: "k8slt.work"
    APPDOMAIN: "audit-p2"
    KAFKA1: kafka-b1.k8slt.work
    KAFKA2: kafka-b2.k8slt.work
    KAFKA3: kafka-b3.k8slt.work
    IPS1: 10.77.7.15
    IPS2: 10.77.7.21
    IPS3: 10.77.7.27
    TLS: cloudflare-tls
  tags:
    - lt

pentest deploy:
  extends: .k8sdeploy
  when: manual
  environment:
    name: pentest
#  only:
#     - main
  variables:
    K8S_ENV: pentest
    NAMESPACE: "audit"
    K8SCONF: "$PENTEST_KUBECFG"
    DOMAIN_CI: "penp2.work"
    APPDOMAIN: "audit-p2"
    KAFKA1: kafka-b1.penp2.work
    KAFKA2: kafka-b2.penp2.work
    KAFKA3: kafka-b3.penp2.work
    IPS1: 10.45.45.12
    IPS2: 10.45.45.20
    IPS3: 10.45.45.27
    TLS: cloudflare-tls
  tags:
    - pentest

stage deploy:
  extends: .k8sdeploy
  when: manual
  environment:
    name: stage
  only:
    - main
    - web
  variables:
    K8S_ENV: stage
    NAMESPACE: "core2"
    K8SCONF: "$LTKUBECFG"
    DOMAIN_CI: "k8slt.work"
    APPDOMAIN: "audit-stage"
    KAFKA1: kafka-b1.k8slt.work
    KAFKA2: kafka-b2.k8slt.work
    KAFKA3: kafka-b3.k8slt.work
    IPS1: 10.77.7.15
    IPS2: 10.77.7.21
    IPS3: 10.77.7.27
    TLS: cloudflare-tls
  tags:
    - lt

prod deploy:
  extends: .k8sdeploy
  when: manual
  environment:
    name: production
  only:
    - main
    - web
  variables:
    K8S_ENV: production
    NAMESPACE: "audit"
    K8SCONF: "$PROD_KUBECFG"
    DOMAIN_CI: "k8platform.xyz"
    APPDOMAIN: "audit-p2"
    KAFKA1: kafka-prod-b1.k8platform.xyz
    KAFKA2: kafka-prod-b2.k8platform.xyz
    KAFKA3: kafka-prod-b3.k8platform.xyz
    IPS1: 10.66.6.35
    IPS2: 10.66.6.36
    IPS3: 10.66.6.37
    TLS: cloudflare-tls
  tags:
    - prod
